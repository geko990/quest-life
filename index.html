<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Real Playing Game</title>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            // Ignora errori di resizeObserver loop che sono benigni
            if (msg.includes('ResizeObserver')) return false;

            alert("Errore Critico:\n" + msg + "\nLine: " + line + "\nURL: " + url);
            // Tenta di mostrare i dati grezzi se possibile
            document.body.innerHTML += '<div style="color:red; background:white; padding:20px; z-index:9999; position:fixed; top:0; left:0; width:100%">' + msg + ' at line ' + line + '</div>';
            return false;
        };
        // Catch unhandled promise rejections (async errors)
        window.onunhandledrejection = function (event) {
            alert("Errore Async:\n" + event.reason);
        };
    </script>
    <script>
        // AGGRESSIVE CACHE CLEARING - v2.8.25
        // Unregister old service workers and clear caches on first load
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => {
                    reg.unregister().then(() => console.log('SW unregistered'));
                });
            });
            caches.keys().then(names => {
                names.forEach(name => {
                    if (!name.includes('v2.7.75')) {
                        caches.delete(name).then(() => console.log('Cache deleted:', name));
                    }
                });
            });
        }
    </script>
    <title>Quest Life RPG</title>
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f1a">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Orbitron:wght@400;700&family=Outfit:wght@300;400;500;600;700&family=Patrick+Hand&display=swap"
        rel="stylesheet">
    <script src="js/theme-fix.js"></script>
    <link rel="stylesheet" href="styles.css?v=3.2.10">

</head>

<body>
    <div class="app-container">

        <!-- Header -->
        <header class="app-header">
            <!-- Streak Icon (Redesigned) -->
            <div class="header-streak grayscale" id="headerStreak" onclick="toggleStreakPopup()">
                <div class="streak-circle">
                    <span class="streak-emoji">üî•</span>
                </div>
                <div class="streak-badge-count">
                    <span id="globalStreak">0</span>
                </div>
            </div>

            <h1 class="app-title" onclick="updateApp()" style="cursor: pointer;">Real Playing Game</h1>

            <!-- Compact Profile (Avatar + Level) -->
            <div class="header-profile" onclick="toggleProfilePopup()">
                <div class="header-avatar-frame" id="headerAvatarFrame">
                    <span class="header-emoji" id="headerEmoji">‚öîÔ∏è</span>
                    <img class="header-img hidden" id="headerImg" src="" alt="">
                </div>
                <div class="header-level-badge">
                    <span id="headerLevel">1</span>
                </div>
            </div>
        </header>

        <!-- Profile Popup -->
        <div class="profile-popup popup-right hidden" id="profilePopup">
            <div class="popup-header-info">
                <div class="popup-avatar-frame" onclick="openAvatarModal()">
                    <span class="popup-emoji" id="popupEmoji">‚öîÔ∏è</span>
                    <img class="popup-img hidden" id="popupImg" src="" alt="">
                    <div class="edit-avatar-icon">‚úé</div>
                </div>
                <div class="popup-details">
                    <h3 class="popup-name" id="popupName">Avventuriero</h3>
                    <div class="popup-level-info">
                        <span class="popup-level">Livello <span id="popupLevel">1</span></span>
                        <span class="popup-title" id="popupTitle">Novizio</span>
                    </div>
                </div>
            </div>

            <div class="popup-xp-container">
                <div class="popup-xp-bar">
                    <div class="popup-xp-fill" id="popupXpFill" style="width: 0%"></div>
                </div>
                <div class="popup-xp-text" id="popupXpText">0 / 100 XP</div>

                <!-- Medal Progress (Now Clickable) -->
                <div class="clickable" onclick="openArchive()" style="margin-top: 15px; cursor: pointer;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; font-weight: bold;">
                        MEDAGLIE MENSILI</div>
                    <div class="popup-xp-bar">
                        <div class="popup-xp-fill" id="monthlyProgressFill"
                            style="width: 0%; background: var(--accent-gold);"></div>
                    </div>
                    <div class="popup-xp-text" style="display: flex; justify-content: space-between;">
                        <span id="monthlyLabel">Gennaio</span>
                        <span id="monthlyPoints" style="font-weight: bold; color: var(--accent-primary);">0/50</span>
                    </div>
                    <div id="monthlyPyramidStatus"
                        style="font-size: 10px; margin-top: 4px; color: var(--text-muted); display: flex; justify-content: space-between; gap: 4px;">
                        <!-- JS injected -->
                    </div>
                </div>
            </div>

            <!-- Medals Grid (Recent) -->
            <div class="popup-motto-container" style="margin-top: 10px;">
                <label>Medagliere</label>
                <div class="medals-grid" id="medalsGrid"
                    style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                    <!-- Medals will be rendered here -->
                </div>
            </div>

            <!-- Motto Moved to Bottom -->
            <div class="popup-motto-container" style="margin-top: 10px;">
                <label>Motto Personale</label>
                <div class="motto-display" id="popupMottoDisplay" onclick="openMottoEdit()">
                    "Il tuo motto qui..."
                </div>
            </div>
        </div>

        <!-- Streak Popup -->
        <div class="profile-popup popup-left hidden" id="streakPopup">
            <div class="popup-header-info">
                <div class="popup-avatar-frame" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <span class="popup-emoji">üî•</span>
                </div>
                <div class="popup-details">
                    <h3 class="popup-name">Serie Attiva</h3>
                    <div class="popup-level-info">
                        <span class="popup-level"><span id="popupStreakCount">0</span> Giorni</span>
                    </div>
                </div>
            </div>

            <div class="popup-motto-container">
                <label>Congelamenti Disponibili</label>
                <div class="freeze-info">
                    <span class="freeze-icon">‚ùÑÔ∏è</span>
                    <span class="freeze-count" id="popupFreezeCount">2</span>
                    <span class="freeze-max">/ 2 questo mese</span>
                </div>
                <p class="freeze-desc">
                    I congelamenti prevengono l'azzeramento della serie se salti un giorno. Si ripristinano il 1¬∞ di
                    ogni mese.
                </p>
            </div>
        </div>

        <!-- XP Toast Notification -->
        <div class="xp-toast hidden" id="xpToast">
            <span class="xp-toast-icon">‚ö°</span>
            <span class="xp-toast-text" id="xpToastText">+10 XP</span>
        </div>

        <!-- Content Sections -->
        <main class="content-area">

            <!-- HOME Section -->
            <section id="section-home" class="section active">
                <!-- VIEW: STATUS (Hero Info) -->
                <div id="view-home-status" class="home-view active">
                    <div class="character-sheet">
                        <div class="stats-chart-container">
                            <canvas id="statsRadar"></canvas>
                        </div>

                        <!-- Attributes Accordion -->
                        <div class="accordion">
                            <div class="accordion-header">
                                <span onclick="toggleAccordion('attributes')">‚öîÔ∏è Attributi</span>
                                <div class="accordion-actions">
                                    <button class="add-btn-circle" onclick="openModal('attribute')">+</button>
                                    <span class="accordion-arrow" id="arrow-attributes"
                                        onclick="toggleAccordion('attributes')">‚ñº</span>
                                </div>
                            </div>
                            <div class="accordion-content expanded" id="content-attributes">
                                <div class="stats-grid" id="attributesList"></div>
                            </div>
                        </div>

                        <!-- Abilities Accordion -->
                        <div class="accordion">
                            <div class="accordion-header">
                                <span onclick="toggleAccordion('abilities')">‚ú® Abilit√†</span>
                                <div class="accordion-actions">
                                    <button class="add-btn-circle" onclick="openModal('ability')">+</button>
                                    <span class="accordion-arrow" id="arrow-abilities"
                                        onclick="toggleAccordion('abilities')">‚ñº</span>
                                </div>
                            </div>
                            <div class="accordion-content expanded" id="content-abilities">
                                <div class="stats-grid" id="abilitiesList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- HABITS Section -->
            <section id="section-habits" class="section">
                <!-- Calendar Header (scroll up to reveal) -->
                <div class="calendar-container" id="calendarContainer">
                    <div class="calendar-scroll" id="calendarScroll"></div>
                </div>

                <!-- Habits Wrapper - occupa tutta l'altezza visibile -->
                <div class="habits-wrapper">
                    <div class="section-header">
                        <h2>üìú Abitudini</h2>
                        <div class="header-actions" style="display: flex; gap: 8px;">
                            <button class="add-btn-circle" onclick="openPomodoroTimer()"
                                title="Timer Pomodoro">üçÖ</button>
                            <button class="add-btn-circle" onclick="openModal('habit')">+</button>
                        </div>
                    </div>
                    <div class="habits-list" id="habitsList"></div>
                </div>
            </section>

            <!-- NUTRITION Section -->
            <section id="section-nutrition" class="section">
                <div class="nutrition-page">
                    <div class="nutrition-container">
                        <!-- Dashboard Salute -->
                        <div class="health-dashboard" style="margin-top:0;">
                            <!-- Calorie Card -->
                            <div class="health-card calories-card">
                                <div class="card-title">Calorie</div>
                                <div class="card-subtitle">Rimanente = Obiettivo - Cibo + Esercizio</div>

                                <div class="calories-main">
                                    <div class="ring-container" onclick="openHealthInput('consumed_manual')">
                                        <svg width="140" height="140" viewBox="0 0 140 140">
                                            <circle class="ring-bg" cx="70" cy="70" r="60" fill="transparent"
                                                stroke-width="10"></circle>
                                            <circle id="calorieRing" class="ring-fill" cx="70" cy="70" r="60"
                                                fill="transparent" stroke-width="10" stroke-dasharray="376.99"
                                                stroke-dashoffset="376.99" stroke-linecap="round"></circle>
                                        </svg>
                                        <div class="ring-content">
                                            <span id="caloriesRemaining" class="remaining-value">1600</span>
                                            <span class="remaining-label">Rimanenti</span>
                                        </div>
                                    </div>

                                    <div class="calories-stats">
                                        <div class="stat-item" onclick="openHealthInput('goal')">
                                            <span class="stat-icon">üö©</span>
                                            <div class="stat-info">
                                                <div class="stat-label">Obiettivo base</div>
                                                <div id="calorieGoal" class="stat-value">1600</div>
                                            </div>
                                        </div>
                                        <div class="stat-item" onclick="openMealsModal()">
                                            <span class="stat-icon" style="color: #3b82f6;">üç¥</span>
                                            <div class="stat-info">
                                                <div class="stat-label">Alimenti</div>
                                                <div id="caloriesConsumed" class="stat-value">0</div>
                                                <div style="font-size:10px; color:var(--text-muted)">Prot: <span
                                                        id="proteinsConsumed">0</span>g</div>
                                            </div>
                                        </div>
                                        <div class="stat-item" onclick="openHealthInput('burned')">
                                            <span class="stat-icon" style="color: #f97316;">üî•</span>
                                            <div class="stat-info">
                                                <div class="stat-label">Esercizi</div>
                                                <div id="caloriesBurned" class="stat-value">0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="health-row">
                                <!-- Step Card -->
                                <div class="health-card steps-card" onclick="openHealthInput('steps')">
                                    <div class="card-title">Passi</div>
                                    <div class="steps-main">
                                        <span class="steps-icon">üëü</span>
                                        <span id="stepsCurrent" class="steps-value">0</span>
                                    </div>
                                    <div class="steps-goal">Obiettivo: <span id="stepsGoalText">10.000</span></div>
                                    <div class="progress-bar-bg">
                                        <div id="stepsProgressBar" class="progress-bar-fill"></div>
                                    </div>
                                </div>

                                <!-- Protein Card (New) -->
                                <div class="health-card protein-card" onclick="openHealthInput('protein_goal')">
                                    <div class="card-title">Proteine</div>
                                    <div class="steps-main">
                                        <span class="steps-icon">üçó</span>
                                        <span id="proteinsCurrentValue" class="steps-value">0</span><small
                                            style="font-size:12px; margin-left:2px;">g</small>
                                    </div>
                                    <div class="steps-goal">Obiettivo: <span id="proteinsGoalText">0</span>g</div>
                                    <div class="progress-bar-bg">
                                        <div id="proteinsProgressBar" class="progress-bar-fill"
                                            style="background: var(--accent-primary);"></div>
                                    </div>
                                </div>

                                <!-- Water Card (v3.1.30 Refinement) -->
                                <div class="health-card water-card" onclick="openHealthInput('water_goal')">
                                    <div class="card-title">Acqua</div>
                                    <div class="steps-main">
                                        <span class="steps-icon" onclick="addWater(0.25); event.stopPropagation();"
                                            style="cursor:pointer;" title="Aggiungi 250ml">ü•õ</span>
                                        <span id="waterCurrentValue" class="steps-value">0</span><small
                                            style="font-size:12px; margin-left:2px;">l</small>
                                    </div>
                                    <div class="steps-goal">Obiettivo: <span id="waterGoalText">2</span>l</div>
                                    <div class="progress-bar-bg">
                                        <div id="waterProgressBar" class="progress-bar-fill"
                                            style="background: #0ea5e9;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="health-row">
                                <!-- Weight Card -->
                                <div class="health-card weight-card" onclick="openWeightModal()">
                                    <div class="card-title">Peso</div>
                                    <div class="steps-main">
                                        <span class="steps-icon">‚öñÔ∏è</span>
                                        <span id="weightCurrent" class="steps-value">75</span>
                                        <span class="unit">kg</span>
                                    </div>
                                    <div class="weight-details-mini" id="weightDetailsMini">
                                        <span>Magra: <b id="leanCurrent">--</b></span>
                                        <span>Grassa: <b id="fatCurrent">--</b></span>
                                    </div>
                                    <div class="progress-bar-bg" style="margin-top:5px;">
                                        <div id="weightProgressBar" class="progress-bar-fill"
                                            style="background: #ec4899;"></div>
                                    </div>
                                </div>
                                <!-- History/Stats Card -->
                                <div class="health-card history-card" onclick="showHealthHistory()">
                                    <div class="card-title">Andamento</div>
                                    <div class="history-main">
                                        <span class="history-icon" style="font-size: 24px;">üìä</span>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 5px;">
                                            Vedi medie e storico
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Spesa Integration -->
                        <div class="nutrition-inventory health-card" style="margin-top: 20px;">
                            <div class="section-header" style="padding: 0 10px; margin-bottom: 10px;">
                                <h3 style="font-family: var(--font-header);">üõí Spesa</h3>
                                <button class="add-btn-circle" onclick="openAddItemModal()">+</button>
                            </div>
                            <div class="inventory-tabs">
                                <button class="inv-tab active" id="nutrition-food-btn"
                                    onclick="switchNutritionTab('food')">Cibo</button>
                                <button class="inv-tab" id="nutrition-home-btn"
                                    onclick="switchNutritionTab('home')">Casa</button>
                            </div>
                            <div id="nutritionList" class="stats-grid" style="padding: 10px;">
                                <!-- Popolato dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ACTIVITIES Section -->
            <section id="section-activities" class="section">
                <!-- Sub-navigation -->
                <div class="activities-tabs">
                    <button class="activity-tab active" id="tab-oneshot" onclick="switchActivityTab('oneshot')">
                        <span>üí•</span> Missioni
                    </button>
                    <button class="activity-tab" id="tab-quest" onclick="switchActivityTab('quest')">
                        <span>üèÜ</span> Campagne
                    </button>
                </div>

                <!-- VIEW: ONE SHOT (MISSIONI) -->
                <div id="view-activities-oneshot" class="activity-view active">
                    <div class="section-header">
                        <h2>üí• Missioni</h2>
                        <div class="header-actions" style="display: flex; gap: 8px;">
                            <button class="add-btn-circle" id="diceButtonTrigger" onclick="showDailyPlanner()"
                                title="√à il tuo turno!">üé≤</button>
                            <button class="add-btn-circle" onclick="openModal('oneshot')">+</button>
                        </div>
                    </div>
                    <div class="oneshot-list" id="oneshotList"></div>
                </div>

                <!-- VIEW: QUEST (CAMPAGNE) -->
                <div id="view-activities-quest" class="activity-view">
                    <div class="section-header">
                        <h2>üèÜ Campagne</h2>
                        <div class="header-actions" style="display: flex; gap: 8px;">
                            <button class="add-btn-circle" onclick="showChallengeCatalog()"
                                title="Sfide Preset">‚öîÔ∏è</button>
                            <button class="add-btn-circle" onclick="openModal('quest')">+</button>
                        </div>
                    </div>
                    <div class="quest-list" id="questList"></div>
                </div>
            </section>

            <!-- SETTINGS Section -->
            <section id="section-settings" class="section">
                <h2>‚öôÔ∏è Impostazioni</h2>

                <!-- Profilo & Gameplay -->
                <div class="settings-group collapsed" id="group-profile">
                    <h3 onclick="toggleSettingsGroup(this)">üë§ Profilo & Gameplay <span class="group-arrow">‚ñº</span>
                    </h3>
                    <div class="settings-content">
                        <div class="settings-row">
                            <label>Nome</label>
                            <input type="text" id="settingName" placeholder="Il tuo nome"
                                onchange="updatePlayerName(this.value)">
                        </div>
                        <div class="recap-history-card" onclick="showRecapHistory()">
                            <div class="recap-history-card-icon">üìú</div>
                            <div class="recap-history-card-text">
                                <div class="recap-history-card-title">Storico Imprese</div>
                                <div class="recap-history-card-sub">Visualizza i tuoi recap settimanali</div>
                            </div>
                            <div class="recap-history-card-arrow">‚Ä∫</div>
                        </div>
                        <div class="settings-row">
                            <label>Inizio nuovo giorno</label>
                            <select id="dayStartTime" onchange="updateDayStartTime(this.value)">
                                <option value="0">00:00 (Mezzanotte)</option>
                                <option value="1">01:00</option>
                                <option value="2">02:00</option>
                                <option value="3">03:00</option>
                                <option value="4">04:00</option>
                                <option value="5">05:00</option>
                                <option value="6">06:00</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <label>Inizio Settimana</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn" id="weekStartMon"
                                    onclick="setWeekStart('monday')">Lun</button>
                                <button class="theme-btn active" id="weekStartSun"
                                    onclick="setWeekStart('sunday')">Dom</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personalizzazione -->
                <div class="settings-group collapsed" id="group-custom">
                    <h3 onclick="toggleSettingsGroup(this)">üé® Personalizzazione <span class="group-arrow">‚ñº</span></h3>
                    <div class="settings-content">
                        <div class="settings-row">
                            <label>Tema</label>
                            <div class="theme-controls-stack">
                                <div id="themeTrigger" class="theme-select-trigger" onclick="toggleThemeDropdown()">
                                    <span id="themeTriggerIcon">üì±</span>
                                    <span id="themeTriggerText">Standard</span>
                                </div>
                                <div id="themeDropdown" class="theme-select-dropdown hidden">
                                    <div class="theme-option" onclick="setTheme('standard')">üì± Standard</div>
                                    <div class="theme-option" onclick="setTheme('fantasy')">üíç Fantasy</div>
                                    <div class="theme-option" onclick="setTheme('dnd')">üìú D&D</div>
                                    <div class="theme-option" onclick="setTheme('futuristic')">üëæ Tron</div>
                                    <div class="theme-option" onclick="setTheme('pirate')">üè¥‚Äç‚ò†Ô∏è Pirate</div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Modalit√†</label>
                            <div class="mode-toggle-large">
                                <button class="mode-btn-large active" id="modeLight" onclick="setMode('light')">‚òÄÔ∏è
                                    Chiaro</button>
                                <button class="mode-btn-large" id="modeDark" onclick="setMode('dark')">üåô Scuro</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Colore accento</label>
                            <div class="color-select-container">
                                <div id="colorTrigger" class="color-select-trigger" onclick="toggleColorDropdown()">
                                    <span class="trigger-icon">üé®</span>
                                </div>
                                <div id="colorDropdown" class="color-select-dropdown hidden"></div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Sfondo Animato</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="animBgOn"
                                    onclick="setPopupSetting('animatedBackground', true)">ON</button>
                                <button class="theme-btn" id="animBgOff"
                                    onclick="setPopupSetting('animatedBackground', false)">OFF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funzionalit√† -->
                <div class="settings-group collapsed" id="group-features">
                    <h3 onclick="toggleSettingsGroup(this)">‚ö° Funzionalit√† <span class="group-arrow">‚ñº</span></h3>
                    <div class="settings-content">
                        <div class="settings-row">
                            <label>Nuovo Turno</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="dailyPlannerOn"
                                    onclick="setPopupSetting('enableDailyPlanner', true)">ON</button>
                                <button class="theme-btn" id="dailyPlannerOff"
                                    onclick="setPopupSetting('enableDailyPlanner', false)">OFF</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Effetti Sonori</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="soundOn"
                                    onclick="setPopupSetting('soundEnabled', true)">ON</button>
                                <button class="theme-btn" id="soundOff"
                                    onclick="setPopupSetting('soundEnabled', false)">OFF</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Recap Settimanale</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="weeklyRecapOn"
                                    onclick="setPopupSetting('enableWeeklyRecap', true)">ON</button>
                                <button class="theme-btn" id="weeklyRecapOff"
                                    onclick="setPopupSetting('enableWeeklyRecap', false)">OFF</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>üé≤ Bottone Dado</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="diceButtonOn"
                                    onclick="setPopupSetting('showDiceButton', true)">ON</button>
                                <button class="theme-btn" id="diceButtonOff"
                                    onclick="setPopupSetting('showDiceButton', false)">OFF</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Apri Turno Manuale</label>
                            <button class="settings-btn" onclick="showDailyPlanner()" style="flex:1;">üé≤ √à il tuo
                                Turno!</button>
                        </div>
                    </div>
                </div>

                <!-- Dati & Cloud -->
                <div class="settings-group collapsed" id="group-data">
                    <h3 onclick="toggleSettingsGroup(this)">üíæ Dati & Cloud <span class="group-arrow">‚ñº</span></h3>
                    <div class="settings-content">
                        <!-- Database Connection -->
                        <div id="dbConnectionSection"
                            style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin:0;">Database File</label>
                                <span id="dbStatus" style="font-size: 0.8rem;"><span
                                        style="color:var(--text-muted)">Nessun
                                        file collegato</span></span>
                            </div>
                            <button class="settings-btn" id="dbActionBtn" onclick="linkDatabaseFile()"
                                style="width: 100%; justify-content: center;">
                                <span class="settings-btn-icon">üîó</span>
                                <span>Collega Database</span>
                            </button>
                            <p
                                style="font-size: 0.75rem; color: var(--text-muted); margin: 6px 0 0 0; text-align: center;">
                                Salva automaticamente le modifiche su un file locale (solo Desktop).
                            </p>
                        </div>

                        <!-- Backup Status (Mobile) -->
                        <div id="backupStatusSection" style="margin-bottom: 12px; display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 0 4px;">
                                <span style="font-size: 0.9rem; color: var(--text-muted);">Ultimo Backup:</span>
                                <span id="lastBackupLabel" style="font-size: 0.9rem; font-weight: bold;">Mai</span>
                            </div>
                            <div id="backupWarning"
                                style="color: var(--accent-orange); font-size: 0.8rem; margin-top: 4px; display: none;">
                                ‚ö†Ô∏è Backup consigliato (pi√π di 7 giorni)
                            </div>
                        </div>

                        <div class="settings-buttons">
                            <button class="settings-btn" onclick="exportData()">
                                <span class="settings-btn-icon">üì§</span>
                                <span>Esporta</span>
                            </button>
                            <button class="settings-btn" onclick="document.getElementById('importFile').click()">
                                <span class="settings-btn-icon">üì•</span>
                                <span>Importa</span>
                            </button>
                            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                        </div>
                        <div class="settings-buttons" style="margin-top: 12px;">
                            <button class="settings-btn" onclick="fixData()">
                                <span class="settings-btn-icon">üîß</span>
                                <span>Ripara</span>
                            </button>
                            <button class="settings-btn" onclick="rebuildStreaksUI()">
                                <span class="settings-btn-icon">üî•</span>
                                <span>Ripara Streak</span>
                            </button>
                            <button class="settings-btn danger" onclick="resetAll()">
                                <span class="settings-btn-icon">‚ö†Ô∏è</span>
                                <span>Reset</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Info & Installazione -->
                <div class="settings-group">
                    <h3 onclick="toggleSettingsGroup(this)">‚ÑπÔ∏è Info & Installazione <span class="group-arrow">‚ñº</span>
                    </h3>
                    <div class="settings-content">
                        <button class="settings-btn" onclick="openInstallModal()"
                            style="width: 100%; margin-bottom: 12px; justify-content: center; background: var(--accent-gradient); color: white; border: none;">
                            <span class="settings-btn-icon">üì±</span>
                            <span>Come installare l'App</span>
                        </button>

                        <div class="settings-buttons">
                            <button class="settings-btn" onclick="updateApp()">
                                <span class="settings-btn-icon">üîÑ</span>
                                <span>Aggiorna App</span>
                            </button>
                        </div>
                        <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center;">
                            Versione: <span id="appVersion" onclick="updateApp()"
                                style="pointer-events: auto; cursor:pointer; text-decoration:underline;">3.2.17</span> ‚Ä¢
                            Quest Life PWA
                        </p>
                    </div>
                </div>
            </section>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" id="bottomNav">
            <div class="nav-bubble" id="navBubble"></div>
            <a href="#" class="nav-item" data-section="habits" onclick="switchSection('habits')">
                <span class="nav-icon">üìú</span>
            </a>
            <a href="#" class="nav-item" data-section="activities" onclick="switchSection('activities')">
                <span class="nav-icon">üéØ</span>
            </a>
            <div class="nav-center-container">
                <a href="#" class="nav-item nav-home active" data-section="home" onclick="switchSection('home')">
                    <span class="nav-icon" id="navAvatar">üë§</span>
                </a>
            </div>
            <a href="#" class="nav-item" data-section="nutrition" onclick="switchSection('nutrition')">
                <span class="nav-icon">üçé</span>
            </a>
            <a href="#" class="nav-item" data-section="settings" onclick="switchSection('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
            </a>
        </nav>

    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal" id="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Aggiungi</h3>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>



    <!-- Avatar Modal -->
    <div class="modal-overlay" id="avatarModalOverlay" onclick="closeAvatarModal()">
        <div class="modal avatar-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Scegli Avatar</h3>
            </div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
        <div class="avatar-tab-content hidden" id="uploadTab">
            <input type="file" id="avatarUpload" accept="image/*" onchange="handleAvatarUpload(event)">
            <label for="avatarUpload" class="upload-label">
                üì∑ Carica una foto
            </label>
        </div>
    </div>
    </div>
    </div>

    <!-- Stats Visibility Popup -->
    <div class="stats-visibility-popup hidden" id="visibilityPopup">
        <h4>üëÅÔ∏è Mostra nel grafico</h4>
        <div id="visibilityList"></div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Streak Celebration Popup -->
    <div class="streak-celebration hidden" id="streakCelebration" onclick="closeStreakCelebration()">
        <div class="celebration-content">
            <div class="celebration-flame">üî•</div>
            <div class="celebration-title">STREAK!</div>
            <div class="celebration-count" id="celebrationCount">0</div>
            <div class="celebration-hint">Tocca per continuare</div>
        </div>
    </div>

    <!-- Quest Detail Modal -->
    <div class="quest-popup-overlay" id="questDetailModal" onclick="closeQuestDetailModal()">
        <div class="quest-detail-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="questDetailTitle">Titolo Quest</span>
            </div>
            <div class="modal-body">
                <div class="quest-detail-meta" id="questDetailMeta">
                    <!-- Dynamic content -->
                </div>
                <p class="quest-description" id="questDetailDesc">
                    <!-- Dynamic content -->
                </p>

                <h3 class="subsection-title" id="questSubtasksTitle" style="margin-top: 20px;">Sotto-obiettivi</h3>
                <div class="quest-subtasks-list" id="questDetailSubtasks">
                    <!-- Dynamic content -->
                </div>
            </div>
            <!-- Footer Removed -->
        </div>
    </div>

    <!-- Stat Detail Modal (Glassmorphism Boxless) -->
    <div class="modal-overlay" id="statDetailOverlay" onclick="closeStatDetailModal()"></div>
    <div class="profile-popup popup-center hidden" id="statDetailModal" onclick="event.stopPropagation()">
        <div id="statDetailContent" style="padding: 10px 5px;">
            <!-- Dynamic Boxless Content: Icon Name -> Liv -> Bar -> Momentum -> Activity -->
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal-overlay" id="inventoryOverlay" onclick="closeInventory()"></div>
    <div class="profile-popup popup-center hidden" id="inventoryModal" onclick="event.stopPropagation()">
        <div class="profile-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin:0; font-size: 20px;">üéí Zaino</h2>
                <button class="add-btn-circle" id="inventoryAddBtn" onclick="openModal('supply')"
                    style="width: 28px; height: 28px; font-size: 16px;">+</button>
            </div>

            <!-- Tab Switcher -->
            <div class="avatar-tabs" style="margin-bottom: 15px;">
                <button class="avatar-tab active" id="tab-supplies" onclick="switchInventoryTab('supplies')">üçé
                    Sostentamento</button>
                <button class="avatar-tab" id="tab-toxic" onclick="switchInventoryTab('toxic')">üíÄ Tossico</button>
            </div>

            <!-- Supplies Tab Content -->
            <div id="suppliesContent" class="inventory-tab-content">
                <!-- Nutrition Streak -->
                <div class="nutrition-streak-card" id="nutritionStreakCard">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">ü•ó</span>
                            <div>
                                <div style="font-weight: 600; font-size: 14px;">Mangiato Sano Oggi</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Serie: <span
                                        id="nutritionStreakCount">0</span> giorni</div>
                            </div>
                        </div>
                        <input type="checkbox" class="card-checkbox" id="nutritionCheckbox"
                            onclick="toggleHealthyEating(event)">
                    </div>
                </div>

                <div id="suppliesList" class="toxic-grid" style="margin-top: 15px;">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Toxic Tab Content -->
            <div id="toxicContent" class="inventory-tab-content hidden">
                <div id="toxicItemList" class="toxic-grid">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Pomodoro Timer Modal -->
    <div class="modal-overlay" id="pomodoroOverlay" onclick="closePomodoroTimer()"></div>
    <div class="profile-popup popup-center hidden" id="pomodoroModal" onclick="event.stopPropagation()">
        <div class="profile-content" style="text-align: center;">
            <h2 style="margin: 0 0 20px 0; font-size: 20px;">üçÖ Pomodoro Timer</h2>

            <div class="pomodoro-display" id="pomodoroDisplay">
                <div class="pomodoro-time" id="pomodoroTime">25:00</div>
                <div class="pomodoro-status" id="pomodoroStatus">Pronto</div>
                <button onclick="testLockScreen()"
                    style="margin-top:10px; font-size:12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding:5px 10px; border-radius:15px; color:white; cursor:pointer;">
                    üîä Test Lock Screen
                </button>
            </div>

            <div class="pomodoro-controls" id="pomodoroControls">
                <button class="pomodoro-btn primary" id="pomodoroStartBtn" onclick="togglePomodoro()">‚ñ∂Ô∏è Avvia</button>
                <button class="pomodoro-btn" onclick="resetPomodoro()">üîÑ Reset</button>
            </div>

            <div class="pomodoro-stats">
                <span>üçÖ Oggi: <strong id="pomodoroCount">0</strong></span>
                <span>‚ö° +<span id="pomodoroXp">20</span> XP</span>
            </div>

            <div class="pomodoro-settings" id="pomodoroSettings">
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Stat</label>
                        <select id="pomodoroStat" onchange="savePomodoroSettings()"></select>
                    </div>
                    <div class="form-group" style="flex: 0 0 80px;">
                        <label>Minuti</label>
                        <input type="number" id="pomodoroDuration" value="25" min="1" max="60"
                            onchange="savePomodoroSettings()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily D&D Planner Modal -->
    <div class="recap-overlay hidden" id="dailyPlannerOverlay"></div>
    <div class="recap-popup hidden" id="dailyPlannerModal" style="max-height: 85vh; overflow-y: auto;">
        <div class="recap-header">
            <h2 style="font-family:'Cinzel', serif; color:var(--accent-primary);">üé≤ √à il tuo turno!</h2>
            <p style="font-size:12px; color:var(--text-muted); margin-top:-5px;">Pianifica le tue azioni per oggi</p>
        </div>

        <div class="daily-planner-slots" id="dailyPlannerSlots" style="display: block !important;">
            <div class="daily-slot" data-slot="action">
                <div class="slot-header">üéØ Azione</div>
                <div class="slot-input-wrapper">
                    <input type="text" class="slot-name" placeholder="Es: Completare il report" style="flex:1;">
                    <button class="pick-task-btn" onclick="openTaskPicker(0)"
                        title="Scegli dalle Missioni/Campagne">üí•</button>
                </div>
                <div class="slot-options">
                    <div class="star-selector" data-stars="3">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
            <div class="daily-slot" data-slot="bonus">
                <div class="slot-header">‚ö° Azione Bonus</div>
                <div class="slot-input-wrapper">
                    <input type="text" class="slot-name" placeholder="Es: Chiamare il medico" style="flex:1;">
                    <button class="pick-task-btn" onclick="openTaskPicker(1)"
                        title="Scegli dalle Missioni/Campagne">üí•</button>
                </div>
                <div class="slot-options">
                    <div class="star-selector" data-stars="2">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star dim" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
            <div class="daily-slot" data-slot="movement">
                <div class="slot-header">üö∂ Movimento</div>
                <div class="slot-input-wrapper">
                    <input type="text" class="slot-name" placeholder="Es: Passeggiata 30min" style="flex:1;">
                    <button class="pick-task-btn" onclick="openTaskPicker(2)"
                        title="Scegli dalle Missioni/Campagne">üí•</button>
                </div>
                <div class="slot-options">
                    <div class="star-selector" data-stars="2">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star dim" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
            <div class="daily-slot" data-slot="reaction">
                <div class="slot-header">üõ°Ô∏è Reazione</div>
                <div class="slot-input-wrapper">
                    <input type="text" class="slot-name" placeholder="Es: Rispondere a 3 email" style="flex:1;">
                    <button class="pick-task-btn" onclick="openTaskPicker(3)"
                        title="Scegli dalle Missioni/Campagne">üí•</button>
                </div>
                <div class="slot-options">
                    <div class="star-selector" data-stars="1">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star dim" data-value="2">‚≠ê</span>
                        <span class="star dim" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
        </div>

        <!-- Quick Pick Section Removed (Now integrated via üí• buttons) -->


        <div id="diceRollResult" class="dice-result hidden">
            <div class="dice-container">
                <div class="d10-dice" id="d10Dice">?</div>
            </div>
            <div class="dice-bonus" id="diceBonus"></div>
        </div>

        <div class="daily-planner-actions" style="display: flex; gap: 8px; margin-top: 10px;">
            <button class="recap-close-btn"
                style="flex:1; background: var(--bg-primary); color: var(--text-primary); padding: 10px;"
                onclick="closeDailyPlanner()">Salta</button>
            <button class="recap-close-btn" style="flex:2;" id="rollDiceBtn" onclick="rollD10AndSave()">üé≤ Lancia un
                D10!</button>
        </div>
    </div>

    <!-- Task Picker Modal (Quick Select for Daily Planner) -->
    <div class="recap-overlay hidden" id="taskPickerOverlay" onclick="closeTaskPicker()"></div>
    <div class="recap-popup hidden" id="taskPickerModal"
        style="max-height: 70vh; overflow-y: hidden; display:flex; flex-direction:column; padding:0; border: 1px solid var(--accent-primary);">
        <div class="recap-header" style="padding: 15px; border-bottom: 1px solid var(--glass-border);">
            <h3 style="margin:0; font-size:16px;">üéØ Scegli Missione o Campagna</h3>
            <p style="font-size:11px; color:var(--text-muted); margin:5px 0 0;">Seleziona un'attivit√† per caricarla
                nello slot</p>
        </div>
        <div id="taskPickerList"
            style="flex:1; overflow-y:auto; padding: 10px; display:flex; flex-direction:column; gap:8px;">
            <!-- Dinamicamente popolato -->
        </div>
        <div style="padding: 10px; border-top: 1px solid var(--glass-border); background: var(--bg-primary);">
            <button class="recap-close-btn" style="width:100%;" onclick="closeTaskPicker()">Annulla</button>
        </div>
    </div>

    <!-- Weekly Recap Modal -->
    <div class="recap-overlay hidden" id="weeklyRecapOverlay" onclick="closeWeeklyRecap()"></div>
    <div class="recap-popup hidden" id="weeklyRecapModal">
        <div class="recap-header">
            <h2>üìä Recap Settimanale</h2>
            <span class="recap-week" id="recapWeekLabel"></span>
        </div>
        <div class="recap-cards" id="recapCards">
            <!-- Dynamically populated -->
        </div>
        <button class="recap-close-btn" onclick="closeWeeklyRecap()">Continua üöÄ</button>
    </div>

    <!-- Recap History Modal -->
    <div class="recap-overlay hidden" id="recapHistoryOverlay" onclick="closeRecapHistory()"></div>
    <div class="recap-popup hidden" id="recapHistoryModal" style="max-height: 80vh; overflow-y: auto; z-index: 10001;"
        onclick="event.stopPropagation()">
        <div class="recap-header">
            <h2>üìú Storico Imprese</h2>
        </div>
        <div id="recapHistoryList" style="margin: 15px 0;">
            <!-- Dynamically populated -->
        </div>
        <button class="recap-close-btn" onclick="closeRecapHistory()">Chiudi</button>
    </div>

    <!-- Medal Detail Modal -->
    <div class="recap-overlay hidden" id="medalDetailOverlay" onclick="closeMedalDetail()"></div>
    <div class="medal-detail-modal hidden" id="medalDetailModal">
        <!-- Dynamically populated by showMedalDetail() -->
    </div>

    <!-- Motto Edit Modal -->
    <div class="modal-overlay" id="mottoEditModal" onclick="closeMottoEdit()">
        <div class="modal motto-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Modifica Motto</h3>
            </div>
            <div class="modal-body">
                <textarea id="mottoEditInput" class="motto-textarea" placeholder="Scrivi il tuo motto..." rows="3"
                    maxlength="100"></textarea>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeMottoEdit()">Annulla</button>
                    <button class="btn-primary" onclick="confirmMottoEdit()">Salva</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Archive Modal -->
    <div class="modal-overlay" id="archiveModal" onclick="closeArchive()">
        <div class="modal archive-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìú Storico Imprese</h3>
            </div>
            <div class="modal-body archive-body">
                <div class="archive-list" id="archiveList">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Immersive Background Canvas -->
    <canvas id="bgCanvas"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; pointer-events: none; opacity: 0; transition: opacity 2s;"></canvas>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="app.js?v=3.2.11" type="module"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js?v=3.2.11')
                .then(() => console.log('Service Worker Registered'))
                .catch((err) => console.log('SW Failed:', err));
        }
    </script>
    <!-- PWA Install Instructions Modal -->
    <div class="modal-overlay hidden" id="installOverlay" onclick="closeInstallModal()"></div>
    <div class="profile-popup popup-center hidden" id="installModal" style="max-width:350px;"
        onclick="event.stopPropagation()">
        <div class="popup-header-info" style="margin-bottom: 10px; justify-content: center;">
            <div class="popup-avatar-frame" style="width: 50px; height: 50px;">
                <div class="popup-emoji" style="font-size: 24px;">üì≤</div>
            </div>
        </div>
        <h3 style="text-align: center; margin-bottom: 15px;">Installa App</h3>

        <div class="popup-details">
            <p
                style="text-align: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 14px; line-height: 1.4;">
                Salva l'app sulla Home per averla sempre con te a schermo intero!
            </p>

            <div
                style="background: var(--bg-primary); padding: 15px; border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                <ol style="padding-left: 20px; font-size: 13px; color: var(--text-primary); line-height: 1.6;">
                    <li style="margin-bottom: 8px;">
                        Apri il menu del browser (<span style="font-style: normal;">üì§</span> su iOS, <span
                            style="font-style: normal;">‚ãÆ</span> su Android).
                    </li>
                    <li style="margin-bottom: 8px;">
                        Seleziona <strong>"Aggiungi alla schermata Home"</strong> o <strong>"Installa app"</strong>.
                    </li>
                    <li>
                        Conferma cliccando su <strong>Aggiungi</strong>.
                    </li>
                </ol>
            </div>

            <div
                style="margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 12px; color: var(--text-muted);">
                <input type="checkbox" id="dontShowInstallAgain" onchange="toggleDontShowInstall(this.checked)"
                    style="accent-color: var(--accent-primary);">
                <label for="dontShowInstallAgain">Non mostrare pi√π in automatico</label>
            </div>

            <button class="settings-btn" onclick="closeInstallModal()"
                style="margin-top: 15px; width: 100%; justify-content: center; background: var(--accent-gradient); color: white; border: none;">
                Capito!
            </button>
        </div>
    </div>

    <!-- Initial Setup Wizard -->
    <div class="modal-overlay hidden" id="setupWizardOverlay" onclick="closeSetupWizard()"></div>
    <div class="profile-popup popup-center hidden" id="setupWizardModal" style="max-width: 380px;"
        onclick="event.stopPropagation()">
        <div class="popup-header-info" style="flex-direction: column; align-items: center; margin-bottom: 15px;">
            <div class="popup-emoji" style="font-size: 48px; margin-bottom: 10px;">‚öîÔ∏è</div>
            <h3 style="margin: 0; text-align: center;">Benvenuto, Avventuriero!</h3>
            <p style="color: var(--text-secondary); text-align: center; font-size: 13px; margin-top: 8px;">
                Configura i tuoi attributi iniziali.<br>Potrai modificarli in seguito.
            </p>
        </div>
        <div id="setupStatsList" style="max-height: 40vh; overflow-y: auto;">
            <!-- Dynamically populated -->
        </div>
        <button class="settings-btn" onclick="completeSetupWizard()"
            style="margin-top: 15px; width: 100%; justify-content: center; background: var(--accent-gradient); color: white; border: none;">
            Inizia l'Avventura! üöÄ
        </button>
    </div>

    <!-- Health Input Modal -->
    <div class="modal-overlay hidden" id="healthInputOverlay" onclick="closeHealthInput()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="healthModalTitle">Aggiorna Parametri</h3>
            </div>
            <div class="modal-body">
                <div id="healthInputContent" class="health-input-group">
                    <!-- Dinamicamente popolato -->
                </div>
            </div>
        </div>
    </div>
    <!-- MEALS MODAL (v3.0.0) -->
    <div id="mealsModal" class="modal-overlay" onclick="closeMealsModal()">
        <div class="modal-content premium-modal"
            style="height: 65vh; width: 90%; max-width: 450px; display: flex; flex-direction: column;"
            onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üçΩÔ∏è Gestione Pasti</h3>
            </div>

            <div class="meals-tabs">
                <button class="meal-tab active" id="meal-tab-breakfast"
                    onclick="switchMealTab('breakfast')">Colazione</button>
                <button class="meal-tab" id="meal-tab-meal" onclick="switchMealTab('meal')">Pasto</button>
                <button class="meal-tab" id="meal-tab-snack" onclick="switchMealTab('snack')">Spuntino</button>
                <button class="meal-tab tab-cheat" id="meal-tab-cheat" onclick="switchMealTab('cheat')">Sgarro</button>
            </div>

            <div id="mealsList" class="meals-list" style="flex: 1; overflow-y: auto;">
                <!-- Popolato dinamicamente -->
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeMealsModal()" style="width: 100%;">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- FOOD MANAGER MODAL -->
    <div id="foodManagerModal" class="modal-overlay" onclick="closeFoodManager()">
        <div class="modal-content premium-modal" onclick="event.stopPropagation()">
            <div class="modal-header" style="justify-content:space-between;">
                <h3>üçé Database Alimenti</h3>
                <button onclick="openFoodForm()"
                    style="background:var(--accent-primary); width:32px; height:32px; border-radius:50%; border:none; color:white; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,0.2);">+</button>
            </div>
            <!-- Removed inline form, now using foodFormModal -->
            <div id="foodDatabaseList" class="meals-list" style="margin-top: 15px; max-height: 200px;"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeFoodManager()" style="width: 100%;">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- FOOD FORM MODAL -->
    <div id="foodFormModal" class="modal-overlay" onclick="closeFoodForm()">
        <div class="modal-content premium-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìù Modifica Alimento</h3>
            </div>
            <div class="meals-input-group" style="flex-direction: column; gap: 12px;">
                <input type="hidden" id="foodEditingId">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="foodEmoji" placeholder="Emoji" style="width: 50px; text-align: center;">
                    <input type="text" id="foodName" placeholder="Nome Alimento" style="flex: 1;">
                </div>

                <div style="font-size:11px; color:var(--text-muted); margin-bottom:-5px; padding-left:5px;">Valori
                    nutrizionali per 100g:</div>
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="foodCalories" placeholder="Kcal" style="flex: 1;">
                    <input type="number" id="foodProteins" placeholder="Proteine (g)" style="flex: 1;">
                </div>

                <div style="font-size:11px; color:var(--text-muted); margin-bottom:-5px; padding-left:5px;">Opzionale:
                </div>
                <input type="number" id="foodUnitGrams" placeholder="Peso per pezzo (g) es. 150 (per 1 mela)"
                    style="width: 100%; font-size: 13px;">

                <select id="foodCategory"
                    style="width: 100%; font-size: 14px; padding: 12px; border-radius: 12px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--glass-border);">
                    <option value="breakfast">Colazione</option>
                    <option value="meal" selected>Pasto</option>
                    <option value="snack">Spuntino</option>
                    <option value="cheat">Sgarro</option>
                </select>

                <button class="btn-primary" onclick="saveFoodToDatabase()" style="width: 100%;">üíæ Salva</button>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeFoodForm()" style="width: 100%;">Annulla</button>
            </div>
        </div>
    </div>

    <!-- GRAM INPUT MODAL -->
    <div id="gramInputModal" class="modal-overlay" onclick="closeGramInput()">
        <div class="modal-content premium-modal" style="max-width: 300px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="gramInputTitle">Inserisci Quantit√†</h3>
            </div>
            <div class="meals-input-group" style="flex-direction: column; gap: 10px;">
                <!-- Type Toggle -->
                <div id="gramInputTypeToggle"
                    style="display: flex; background: var(--bg-main); padding: 4px; border-radius: 20px; border: 1px solid var(--glass-border); margin-bottom: 5px;">
                    <button id="gramInputType-grams" onclick="setGramInputType('grams')"
                        style="flex: 1; border: none; background: var(--accent-primary); color: white; border-radius: 16px; padding: 6px; font-size: 12px; transition: all 0.2s;">Grammi</button>
                    <button id="gramInputType-units" onclick="setGramInputType('units')"
                        style="flex: 1; border: none; background: transparent; color: var(--text-secondary); border-radius: 16px; padding: 6px; font-size: 12px; transition: all 0.2s;">Pezzi</button>
                </div>

                <div style="display: flex; gap: 8px;">
                    <input type="number" id="enteredGrams" placeholder="Grammi" style="flex: 1;">
                    <button class="btn-primary" onclick="confirmGramInput()" style="width: auto;">‚úÖ</button>
                </div>
                <!-- Helper text for unit weight -->
                <div id="unitWeightHelper"
                    style="font-size: 11px; color: var(--text-muted); text-align: center; display: none;">
                    (1 pezzo ‚âà <span id="unitWeightValue"></span>g)
                </div>
            </div>
            <div id="gramInputCalculation"
                style="font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 5px;"></div>
        </div>
    </div>

    <!-- EXERCISE MANAGER MODAL -->
    <div id="exerciseManagerModal" class="modal-overlay" onclick="closeExerciseManager()">
        <div class="modal-content premium-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üèãÔ∏è Database Esercizi</h3>
            </div>
            <div class="meals-input-group" style="flex-direction: column; gap: 8px;">
                <div style="display: flex; gap: 4px;">
                    <input type="text" id="exEmoji" placeholder="Eji" style="width: 40px; text-align: center;">
                    <input type="text" id="exName" placeholder="Nome" style="flex: 1;">
                </div>
                <div style="display: flex; gap: 4px;">
                    <input type="number" id="exBaseCount" placeholder="Unit√† (es. 10)" style="flex: 1;">
                    <input type="number" id="exBaseCalories" placeholder="Calorie Bruciate" style="flex: 1;">
                    <input type="number" id="exXpReward" placeholder="XP Reward" style="flex: 1;">
                </div>
                <select id="exStat" style="width: 100%; font-size: 11px;"></select>
                <button class="btn-primary" onclick="saveExerciseToDatabase()" style="width: 100%;">üíæ Salva
                    Esercizio</button>
            </div>
            <div id="exerciseDatabaseList" class="meals-list" style="margin-top: 15px; max-height: 200px;"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeExerciseManager()" style="width: 100%;">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- WEIGHT MODAL (v3.0.0) -->
    <div id="weightModal" class="modal-overlay" onclick="closeWeightModal()">
        <div class="modal-content premium-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>‚öñÔ∏è Peso & Composizione</h3>
            </div>

            <div class="weight-form">
                <div class="form-row" style="display:flex; gap:10px; margin-bottom:15px;">
                    <div class="form-group" style="flex:1;">
                        <label style="font-size:11px; color:var(--text-muted);">Attuale (kg)</label>
                        <input type="number" id="weightInputVal" step="0.1" style="width:100%;">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label style="font-size:11px; color:var(--text-muted);">Target (kg)</label>
                        <input type="number" id="weightTargetInputVal" step="0.1" style="width:100%;">
                    </div>
                </div>
                <div class="form-row" style="display:flex; gap:10px; margin-bottom:15px;">
                    <div class="form-group" style="flex:1;">
                        <label style="font-size:11px; color:var(--text-muted);">Massa Magra (kg)</label>
                        <input type="number" id="leanInputVal" step="0.1" style="width:100%;">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label style="font-size:11px; color:var(--text-muted);">Target Magra (kg)</label>
                        <input type="number" id="leanTargetInputVal" step="0.1" style="width:100%;">
                    </div>
                </div>
                <div class="form-row" style="display:flex; gap:10px; margin-bottom:10px;">
                    <div class="form-group" style="flex:1;">
                        <label style="font-size:11px; color:var(--text-muted);">Massa Grassa (%)</label>
                        <input type="number" id="fatInputVal" step="0.1" style="width:100%;">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label style="font-size:11px; color:var(--text-muted);">Target Grassa (%)</label>
                        <input type="number" id="fatTargetInputVal" step="0.1" style="width:100%;">
                    </div>
                </div>
            </div>

            <div class="modal-actions" style="margin-top:10px;">
                <button class="btn-primary" onclick="saveWeightDetails()" style="width:100%;">Salva</button>
            </div>
        </div>
    </div>

    <!-- ADD ITEM MODAL (v3.1.0) -->
    <div id="addItemModal" class="modal-overlay" onclick="closeAddItemModal()">
        <div class="modal-content premium-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="addItemTitle">Aggiungi Oggetto</h3>
                <!-- Close X Removed -->
            </div>

            <div class="add-item-form">
                <div class="form-group" style="margin-bottom:15px;">
                    <label
                        style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:5px;">Categoria</label>
                    <div style="display:flex; gap:10px;">
                        <button type="button" class="btn-secondary active" id="type-food"
                            onclick="setAddItemType('food')" style="flex:1;">üçé Cibo</button>
                        <button type="button" class="btn-secondary" id="type-home" onclick="setAddItemType('home')"
                            style="flex:1;">üè† Casa</button>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom:15px;">
                    <label for="newItemName" style="font-size:12px; color:var(--text-muted);">Nome</label>
                    <input type="text" id="newItemName" placeholder="Es. Latte, Detersivo..." style="width:100%;">
                </div>

                <div class="form-group" style="margin-bottom:20px;">
                    <label for="newItemEmoji" style="font-size:12px; color:var(--text-muted);">Emoji (Opzionale)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newItemEmoji" placeholder="üçé" style="width:50px; text-align:center;">
                        <span style="font-size:11px; color:var(--text-muted); align-self:center;">Lascia vuoto per
                            default</span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-primary" onclick="saveInventoryItem()" style="width:100%;">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrition Trends Overlay (v3.1.41) -->
    <div class="modal-overlay hidden" id="nutritionTrendsOverlay" onclick="closeNutritionTrends()"></div>
    <div class="profile-popup popup-center hidden" id="nutritionTrendsModal" style="max-width:360px;"
        onclick="event.stopPropagation()">
        <div class="popup-header-info" style="margin-bottom: 10px; justify-content: center;">
            <div class="popup-avatar-frame" style="width: 50px; height: 50px;">
                <div class="popup-emoji" style="font-size: 24px;">üìä</div>
            </div>
        </div>
        <h3 style="text-align: center; margin-bottom: 5px;">Andamento Nutrizione</h3>
        <p style="text-align: center; font-size: 11px; color: var(--text-muted); margin-bottom: 15px;">
            Ultimi 30 giorni
        </p>

        <div style="display: flex; justify-content: center; margin-bottom: 15px;">
            <div class="theme-switcher" style="width: 200px;">
                <button class="theme-btn active" id="btn-view-chart"
                    onclick="toggleNutritionHistoryView('chart')">Grafico</button>
                <button class="theme-btn" id="btn-view-list"
                    onclick="toggleNutritionHistoryView('list')">Elenco</button>
            </div>
        </div>

        <!-- Chart View -->
        <div id="nutrition-chart-view">
            <div class="chart-controls" style="display:flex; justify-content:center; gap:8px; margin-bottom:15px;">
                <button class="chart-tab active" onclick="switchNutritionChart('calories')">üî• Calorie</button>
                <button class="chart-tab" onclick="switchNutritionChart('weight')">‚öñÔ∏è Peso</button>
                <button class="chart-tab" onclick="switchNutritionChart('water')">üíß Acqua</button>
            </div>

            <div class="chart-container" style="position: relative; height: 200px; width:100%;">
                <canvas id="nutritionTrendChart"></canvas>
            </div>
        </div>

        <!-- List View (Hidden by default) -->
        <div id="nutrition-list-view" class="hidden" style="max-height: 250px; overflow-y: auto;">
            <div id="nutritionHistoryList" class="history-list">
                <!-- Dynamic Content -->
            </div>
        </div>

        <button class="btn-primary" onclick="closeNutritionTrends()"
            style="width:100%; margin-top:15px;">Chiudi</button>
    </div>

    <!-- Edit History Entry Modal (v3.1.43) -->
    <div class="modal-overlay hidden" id="editHistoryOverlay" onclick="closeHistoryEditor()"></div>
    <div class="profile-popup popup-center hidden" id="editHistoryModal" style="max-width:320px;"
        onclick="event.stopPropagation()">
        <h3 id="editHistoryDate" style="text-align: center; margin-bottom: 15px;">Modifica Data</h3>

        <div class="edit-history-form">
            <div class="form-group-row">
                <label>üî• Calorie Consumate</label>
                <input type="number" id="editHistCalories">
            </div>
            <div class="form-group-row">
                <label>üî• Calorie Bruciate</label>
                <input type="number" id="editHistBurned">
            </div>
            <div class="form-group-row">
                <label>üçñ Proteine (g)</label>
                <input type="number" id="editHistProteins">
            </div>
            <div class="form-group-row">
                <label>üíß Acqua (L)</label>
                <input type="number" step="0.1" id="editHistWater">
            </div>
            <div class="form-group-row">
                <label>üë£ Passi</label>
                <input type="number" id="editHistSteps">
            </div>
            <div class="form-group-row">
                <label>‚öñÔ∏è Peso (kg)</label>
                <input type="number" step="0.1" id="editHistWeight">
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-secondary" onclick="closeHistoryEditor()" style="flex:1;">Annulla</button>
            <button class="btn-primary" onclick="saveHistoryEntry()" style="flex:1;">Salva</button>
        </div>
    </div>

</body>


</html>