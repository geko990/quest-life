<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Real Playing Game - RPG Habit Tracker</title>
    <title>Quest Life RPG</title>
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f1a">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Orbitron:wght@400;700&family=Outfit:wght@300;400;500;600;700&family=Patrick+Hand&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=2.7.30">

</head>

<body>
    <div class="app-container">

        <!-- Header -->
        <header class="app-header">
            <!-- Streak Icon (Redesigned) -->
            <div class="header-streak grayscale" id="headerStreak" onclick="toggleStreakPopup()">
                <div class="streak-circle">
                    <span class="streak-emoji">üî•</span>
                </div>
                <div class="streak-badge-count">
                    <span id="globalStreak">0</span>
                </div>
            </div>

            <h1 class="app-title" onclick="updateApp()" style="cursor: pointer;">Real Playing Game</h1>

            <!-- Compact Profile (Avatar + Level) -->
            <div class="header-profile" onclick="toggleProfilePopup()">
                <div class="header-avatar-frame" id="headerAvatarFrame">
                    <span class="header-emoji" id="headerEmoji">‚öîÔ∏è</span>
                    <img class="header-img hidden" id="headerImg" src="" alt="">
                </div>
                <div class="header-level-badge">
                    <span id="headerLevel">1</span>
                </div>
            </div>
        </header>

        <!-- Profile Popup -->
        <div class="profile-popup popup-right hidden" id="profilePopup">
            <div class="popup-header-info">
                <div class="popup-avatar-frame" onclick="openAvatarModal()">
                    <span class="popup-emoji" id="popupEmoji">‚öîÔ∏è</span>
                    <img class="popup-img hidden" id="popupImg" src="" alt="">
                    <div class="edit-avatar-icon">‚úé</div>
                </div>
                <div class="popup-details">
                    <h3 class="popup-name" id="popupName">Avventuriero</h3>
                    <div class="popup-level-info">
                        <span class="popup-level">Livello <span id="popupLevel">1</span></span>
                        <span class="popup-title" id="popupTitle">Novizio</span>
                    </div>
                </div>
            </div>

            <div class="popup-xp-container">
                <div class="popup-xp-bar">
                    <div class="popup-xp-fill" id="popupXpFill" style="width: 0%"></div>
                </div>
                <div class="popup-xp-text" id="popupXpText">0 / 100 XP</div>

                <!-- Medal Progress (Now Clickable) -->
                <div class="clickable" onclick="openArchive()" style="margin-top: 15px; cursor: pointer;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; font-weight: bold;">
                        MEDAGLIE MENSILI</div>
                    <div class="popup-xp-bar">
                        <div class="popup-xp-fill" id="monthlyProgressFill"
                            style="width: 0%; background: var(--accent-gold);"></div>
                    </div>
                    <div class="popup-xp-text" style="display: flex; justify-content: space-between;">
                        <span id="monthlyLabel">Gennaio</span>
                        <span id="monthlyPoints" style="font-weight: bold; color: var(--accent-primary);">0/50</span>
                    </div>
                </div>
            </div>

            <!-- Medals Grid (Recent) -->
            <div class="popup-motto-container" style="margin-top: 10px;">
                <label>Medagliere</label>
                <div class="medals-grid" id="medalsGrid"
                    style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                    <!-- Medals will be rendered here -->
                </div>
            </div>

            <!-- Motto Moved to Bottom -->
            <div class="popup-motto-container" style="margin-top: 10px;">
                <label>Motto Personale</label>
                <div class="motto-display" id="popupMottoDisplay" onclick="openMottoEdit()">
                    "Il tuo motto qui..."
                </div>
            </div>
        </div>

        <!-- Streak Popup -->
        <div class="profile-popup popup-left hidden" id="streakPopup">
            <div class="popup-header-info">
                <div class="popup-avatar-frame" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <span class="popup-emoji">üî•</span>
                </div>
                <div class="popup-details">
                    <h3 class="popup-name">Serie Attiva</h3>
                    <div class="popup-level-info">
                        <span class="popup-level"><span id="popupStreakCount">0</span> Giorni</span>
                    </div>
                </div>
            </div>

            <div class="popup-motto-container">
                <label>Congelamenti Disponibili</label>
                <div class="freeze-info">
                    <span class="freeze-icon">‚ùÑÔ∏è</span>
                    <span class="freeze-count" id="popupFreezeCount">2</span>
                    <span class="freeze-max">/ 2 questo mese</span>
                </div>
                <p class="freeze-desc">
                    I congelamenti prevengono l'azzeramento della serie se salti un giorno. Si ripristinano il 1¬∞ di
                    ogni mese.
                </p>
            </div>
        </div>

        <!-- Progress Feedback Popup -->
        <div class="profile-popup popup-center hidden" id="progressPopup">
            <div class="popup-header-info" style="justify-content: center; margin-bottom: 12px;">
                <h3 class="popup-name" style="font-size: 16px; color: var(--accent-primary);">Progresso Rilevato!</h3>
            </div>
            <div style="position: relative; height: 220px; width: 100%; display: flex; justify-content: center;">
                <canvas id="popupRadarCanvas"></canvas>
            </div>
        </div>

        <!-- Content Sections -->
        <main class="content-area">

            <!-- HOME Section -->
            <section id="section-home" class="section active">
                <div class="character-sheet">
                    <!-- Stats Radar Chart -->

                    <!-- Stats Radar Chart -->
                    <div class="stats-chart-container">
                        <canvas id="statsRadar"></canvas>
                    </div>

                    <!-- Attributes Accordion -->
                    <div class="accordion">
                        <div class="accordion-header">
                            <span onclick="toggleAccordion('attributes')">‚öîÔ∏è Attributi</span>
                            <div class="accordion-actions">
                                <button class="add-btn-circle" onclick="openModal('attribute')">+</button>
                                <span class="accordion-arrow" id="arrow-attributes"
                                    onclick="toggleAccordion('attributes')">‚ñº</span>
                            </div>
                        </div>
                        <div class="accordion-content expanded" id="content-attributes">
                            <div class="stats-grid" id="attributesList"></div>
                        </div>
                    </div>

                    <!-- Abilities Accordion -->
                    <div class="accordion">
                        <div class="accordion-header">
                            <span onclick="toggleAccordion('abilities')">‚ú® Abilit√†</span>
                            <div class="accordion-actions">
                                <button class="add-btn-circle" onclick="openModal('ability')">+</button>
                                <span class="accordion-arrow" id="arrow-abilities"
                                    onclick="toggleAccordion('abilities')">‚ñº</span>
                            </div>
                        </div>
                        <div class="accordion-content expanded" id="content-abilities">
                            <div class="stats-grid" id="abilitiesList"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- HABITS Section -->
            <section id="section-habits" class="section">
                <!-- Calendar Header (scroll up to reveal) -->
                <div class="calendar-container" id="calendarContainer">
                    <div class="calendar-scroll" id="calendarScroll"></div>
                </div>

                <!-- Habits Wrapper - occupa tutta l'altezza visibile -->
                <div class="habits-wrapper">
                    <div class="section-header">
                        <h2>üìú Abitudini</h2>
                        <div class="header-actions" style="display: flex; gap: 8px;">
                            <button class="add-btn-circle" onclick="openPomodoroTimer()"
                                title="Timer Pomodoro">üçÖ</button>
                            <button class="add-btn-circle" onclick="openModal('habit')">+</button>
                        </div>
                    </div>
                    <div class="habits-list" id="habitsList"></div>
                </div>
            </section>

            <!-- ONE SHOT Section -->
            <section id="section-oneshot" class="section">
                <div class="section-header">
                    <h2>üí• One Shot</h2>
                    <div class="header-actions" style="display: flex; gap: 8px;">
                        <button class="add-btn-circle" onclick="openToxicInventory()" title="Zaino Tossico">üéí</button>
                        <button class="add-btn-circle" onclick="openModal('oneshot')">+</button>
                    </div>
                </div>
                <div class="oneshot-list" id="oneshotList"></div>
            </section>

            <!-- QUESTS Section -->
            <section id="section-quest" class="section">
                <div class="section-header">
                    <h2>üèÜ Quest</h2>
                    <button class="add-btn-circle" onclick="openModal('quest')">+</button>
                </div>
                <div class="quest-list" id="questList"></div>
            </section>

            <!-- SETTINGS Section -->
            <section id="section-settings" class="section">
                <h2>‚öôÔ∏è Impostazioni</h2>

                <!-- Profilo & Gameplay -->
                <div class="settings-group collapsed" id="group-profile">
                    <h3 onclick="toggleSettingsGroup(this)">üë§ Profilo & Gameplay <span class="group-arrow">‚ñº</span>
                    </h3>
                    <div class="settings-content">
                        <div class="settings-row">
                            <label>Nome</label>
                            <input type="text" id="settingName" placeholder="Il tuo nome"
                                onchange="updatePlayerName(this.value)">
                        </div>
                        <div class="settings-row">
                            <label>Inizio nuovo giorno</label>
                            <select id="dayStartTime" onchange="updateDayStartTime(this.value)">
                                <option value="0">00:00 (Mezzanotte)</option>
                                <option value="1">01:00</option>
                                <option value="2">02:00</option>
                                <option value="3">03:00</option>
                                <option value="4">04:00</option>
                                <option value="5">05:00</option>
                                <option value="6">06:00</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <label>Inizio Settimana</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn" id="weekStartMon"
                                    onclick="setWeekStart('monday')">Lun</button>
                                <button class="theme-btn active" id="weekStartSun"
                                    onclick="setWeekStart('sunday')">Dom</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personalizzazione -->
                <div class="settings-group collapsed" id="group-custom">
                    <h3 onclick="toggleSettingsGroup(this)">üé® Personalizzazione <span class="group-arrow">‚ñº</span></h3>
                    <div class="settings-content">
                        <div class="settings-row">
                            <label>Tema</label>
                            <div class="theme-controls-stack">
                                <div id="themeTrigger" class="theme-select-trigger" onclick="toggleThemeDropdown()">
                                    <span id="themeTriggerIcon">üì±</span>
                                    <span id="themeTriggerText">Standard</span>
                                </div>
                                <div id="themeDropdown" class="theme-select-dropdown hidden">
                                    <div class="theme-option" onclick="setTheme('standard')">üì± Standard</div>
                                    <div class="theme-option" onclick="setTheme('fantasy')">üíç Fantasy</div>
                                    <div class="theme-option" onclick="setTheme('dnd')">üìú D&D</div>
                                    <div class="theme-option" onclick="setTheme('futuristic')">üëæ Tron</div>
                                    <div class="theme-option" onclick="setTheme('pirate')">üè¥‚Äç‚ò†Ô∏è Pirate</div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Modalit√†</label>
                            <div class="mode-toggle-large">
                                <button class="mode-btn-large active" id="modeLight" onclick="setMode('light')">‚òÄÔ∏è
                                    Chiaro</button>
                                <button class="mode-btn-large" id="modeDark" onclick="setMode('dark')">üåô Scuro</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Colore accento</label>
                            <div class="color-select-container">
                                <div id="colorTrigger" class="color-select-trigger" onclick="toggleColorDropdown()">
                                    <span class="trigger-icon">üé®</span>
                                </div>
                                <div id="colorDropdown" class="color-select-dropdown hidden"></div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Sfondo Animato</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="animBgOn"
                                    onclick="setPopupSetting('animatedBackground', true)">ON</button>
                                <button class="theme-btn" id="animBgOff"
                                    onclick="setPopupSetting('animatedBackground', false)">OFF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funzionalit√† -->
                <div class="settings-group collapsed" id="group-features">
                    <h3 onclick="toggleSettingsGroup(this)">‚ö° Funzionalit√† <span class="group-arrow">‚ñº</span></h3>
                    <div class="settings-content">
                        <div class="settings-row">
                            <label>Nuovo Turno</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="dailyPlannerOn"
                                    onclick="setPopupSetting('enableDailyPlanner', true)">ON</button>
                                <button class="theme-btn" id="dailyPlannerOff"
                                    onclick="setPopupSetting('enableDailyPlanner', false)">OFF</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Effetti Sonori</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="soundOn"
                                    onclick="setPopupSetting('soundEnabled', true)">ON</button>
                                <button class="theme-btn" id="soundOff"
                                    onclick="setPopupSetting('soundEnabled', false)">OFF</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label>Recap Settimanale</label>
                            <div class="theme-switcher" style="min-width:120px;">
                                <button class="theme-btn active" id="weeklyRecapOn"
                                    onclick="setPopupSetting('enableWeeklyRecap', true)">ON</button>
                                <button class="theme-btn" id="weeklyRecapOff"
                                    onclick="setPopupSetting('enableWeeklyRecap', false)">OFF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dati & Cloud -->
                <div class="settings-group collapsed" id="group-data">
                    <h3 onclick="toggleSettingsGroup(this)">üíæ Dati & Cloud <span class="group-arrow">‚ñº</span></h3>
                    <div class="settings-content">
                        <!-- Database Connection -->
                        <div id="dbConnectionSection"
                            style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin:0;">Database File</label>
                                <span id="dbStatus" style="font-size: 0.8rem;"><span
                                        style="color:var(--text-muted)">Nessun
                                        file collegato</span></span>
                            </div>
                            <button class="settings-btn" id="dbActionBtn" onclick="linkDatabaseFile()"
                                style="width: 100%; justify-content: center;">
                                <span class="settings-btn-icon">üîó</span>
                                <span>Collega Database</span>
                            </button>
                            <p
                                style="font-size: 0.75rem; color: var(--text-muted); margin: 6px 0 0 0; text-align: center;">
                                Salva automaticamente le modifiche su un file locale (solo Desktop).
                            </p>
                        </div>

                        <!-- Backup Status (Mobile) -->
                        <div id="backupStatusSection" style="margin-bottom: 12px; display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 0 4px;">
                                <span style="font-size: 0.9rem; color: var(--text-muted);">Ultimo Backup:</span>
                                <span id="lastBackupLabel" style="font-size: 0.9rem; font-weight: bold;">Mai</span>
                            </div>
                            <div id="backupWarning"
                                style="color: var(--accent-orange); font-size: 0.8rem; margin-top: 4px; display: none;">
                                ‚ö†Ô∏è Backup consigliato (pi√π di 7 giorni)
                            </div>
                        </div>

                        <div class="settings-buttons">
                            <button class="settings-btn" onclick="exportData()">
                                <span class="settings-btn-icon">üì§</span>
                                <span>Esporta</span>
                            </button>
                            <button class="settings-btn" onclick="document.getElementById('importFile').click()">
                                <span class="settings-btn-icon">üì•</span>
                                <span>Importa</span>
                            </button>
                            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                        </div>
                        <div class="settings-buttons" style="margin-top: 12px;">
                            <button class="settings-btn" onclick="fixData()">
                                <span class="settings-btn-icon">üîß</span>
                                <span>Ripara</span>
                            </button>
                            <button class="settings-btn danger" onclick="resetAll()">
                                <span class="settings-btn-icon">‚ö†Ô∏è</span>
                                <span>Reset</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Info & Installazione -->
                <div class="settings-group">
                    <h3 onclick="toggleSettingsGroup(this)">‚ÑπÔ∏è Info & Installazione <span class="group-arrow">‚ñº</span>
                    </h3>
                    <div class="settings-content">
                        <button class="settings-btn" onclick="openInstallModal()"
                            style="width: 100%; margin-bottom: 12px; justify-content: center; background: var(--accent-gradient); color: white; border: none;">
                            <span class="settings-btn-icon">üì±</span>
                            <span>Come installare l'App</span>
                        </button>

                        <div class="settings-buttons">
                            <button class="settings-btn" onclick="updateApp()">
                                <span class="settings-btn-icon">üîÑ</span>
                                <span>Aggiorna App</span>
                            </button>
                        </div>
                        <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center;">
                            Versione: <span id="appVersion" onclick="updateApp()"
                                style="pointer-events: auto; cursor:pointer; text-decoration:underline;">2.7.30</span> ‚Ä¢
                            Quest Life PWA
                        </p>
                    </div>
                </div>
            </section>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" id="bottomNav">
            <div class="nav-bubble" id="navBubble"></div>
            <a href="#" class="nav-item" data-section="habits" onclick="switchSection('habits')">
                <span class="nav-icon">üìú</span>
            </a>
            <a href="#" class="nav-item" data-section="oneshot" onclick="switchSection('oneshot')">
                <span class="nav-icon">üí•</span>
                <span class="nav-badge hidden" id="oneshotBadge">0</span>
            </a>
            <div class="nav-center-container">
                <a href="#" class="nav-item nav-home active" data-section="home" onclick="switchSection('home')">
                    <span class="nav-icon" id="navAvatar">‚öîÔ∏è</span>
                </a>
            </div>
            <a href="#" class="nav-item" data-section="quest" onclick="switchSection('quest')">
                <span class="nav-icon">üéØ</span>
            </a>
            <a href="#" class="nav-item" data-section="settings" onclick="switchSection('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
            </a>
        </nav>

    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Aggiungi</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>



    <!-- Avatar Modal -->
    <div class="modal-overlay" id="avatarModalOverlay">
        <div class="modal avatar-modal">
            <div class="modal-header">
                <h3>Scegli Avatar</h3>
                <button class="modal-close" onclick="closeAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="avatar-tabs">
                    <button class="avatar-tab active" onclick="switchAvatarTab('emoji')">üòÄ Emoji</button>
                    <button class="avatar-tab" onclick="switchAvatarTab('upload')">üì∑ Foto</button>
                </div>
                <div class="avatar-tab-content" id="emojiTab">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
                <div class="avatar-tab-content hidden" id="uploadTab">
                    <input type="file" id="avatarUpload" accept="image/*" onchange="handleAvatarUpload(event)">
                    <label for="avatarUpload" class="upload-label">
                        üì∑ Carica una foto
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Visibility Popup -->
    <div class="stats-visibility-popup hidden" id="visibilityPopup">
        <h4>üëÅÔ∏è Mostra nel grafico</h4>
        <div id="visibilityList"></div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Streak Celebration Popup -->
    <div class="streak-celebration hidden" id="streakCelebration" onclick="closeStreakCelebration()">
        <div class="celebration-content">
            <div class="celebration-flame">üî•</div>
            <div class="celebration-title">STREAK!</div>
            <div class="celebration-count" id="celebrationCount">0</div>
            <div class="celebration-hint">Tocca per continuare</div>
        </div>
    </div>

    <!-- Quest Detail Modal -->
    <div class="quest-popup-overlay" id="questDetailModal" onclick="closeQuestDetailModal()">
        <div class="quest-detail-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="questDetailTitle">Titolo Quest</span>
            </div>
            <div class="modal-body">
                <div class="quest-detail-meta" id="questDetailMeta">
                    <!-- Dynamic content -->
                </div>
                <p class="quest-description" id="questDetailDesc">
                    <!-- Dynamic content -->
                </p>

                <h3 class="subsection-title" id="questSubtasksTitle" style="margin-top: 20px;">Sotto-obiettivi</h3>
                <div class="quest-subtasks-list" id="questDetailSubtasks">
                    <!-- Dynamic content -->
                </div>
            </div>
            <!-- Footer Removed -->
        </div>
    </div>

    <!-- Stat Detail Modal (Glassmorphism Boxless) -->
    <div class="modal-overlay" id="statDetailOverlay" onclick="closeStatDetailModal()"></div>
    <div class="profile-popup popup-center hidden" id="statDetailModal">
        <div id="statDetailContent" style="padding: 10px 5px;">
            <!-- Dynamic Boxless Content: Icon Name -> Liv -> Bar -> Momentum -> Activity -->
        </div>
    </div>

    <!-- Toxic Inventory Modal -->
    <div class="modal-overlay" id="toxicInventoryOverlay" onclick="closeToxicInventory()"></div>
    <div class="profile-popup popup-center hidden" id="toxicInventoryModal">
        <div class="profile-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0; font-size: 20px;">üéí Zaino Tossico</h2>
                <button class="add-btn-circle" onclick="openModal('toxic')"
                    style="width: 28px; height: 28px; font-size: 16px;">+</button>
            </div>
            <div id="toxicItemList" class="toxic-grid">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Pomodoro Timer Modal -->
    <div class="modal-overlay" id="pomodoroOverlay" onclick="closePomodoroTimer()"></div>
    <div class="profile-popup popup-center hidden" id="pomodoroModal">
        <div class="profile-content" style="text-align: center;">
            <h2 style="margin: 0 0 20px 0; font-size: 20px;">üçÖ Pomodoro Timer</h2>

            <div class="pomodoro-display" id="pomodoroDisplay">
                <div class="pomodoro-time" id="pomodoroTime">25:00</div>
                <div class="pomodoro-status" id="pomodoroStatus">Pronto</div>
            </div>

            <div class="pomodoro-controls" id="pomodoroControls">
                <button class="pomodoro-btn primary" id="pomodoroStartBtn" onclick="togglePomodoro()">‚ñ∂Ô∏è Avvia</button>
                <button class="pomodoro-btn" onclick="resetPomodoro()">üîÑ Reset</button>
            </div>

            <div class="pomodoro-stats">
                <span>üçÖ Oggi: <strong id="pomodoroCount">0</strong></span>
                <span>‚ö° +<span id="pomodoroXp">20</span> XP</span>
            </div>

            <div class="pomodoro-settings" id="pomodoroSettings">
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Stat</label>
                        <select id="pomodoroStat" onchange="savePomodoroSettings()"></select>
                    </div>
                    <div class="form-group" style="flex: 0 0 80px;">
                        <label>Minuti</label>
                        <input type="number" id="pomodoroDuration" value="25" min="1" max="60"
                            onchange="savePomodoroSettings()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily D&D Planner Modal -->
    <div class="recap-overlay hidden" id="dailyPlannerOverlay"></div>
    <div class="recap-popup hidden" id="dailyPlannerModal" style="max-height: 85vh; overflow-y: auto;">
        <div class="recap-header">
            <h2>üé≤ √à il tuo turno!</h2>
        </div>
        <div class="daily-planner-slots" id="dailyPlannerSlots">
            <div class="daily-slot" data-slot="action">
                <div class="slot-header">üéØ Azione Principale</div>
                <input type="text" class="slot-name" placeholder="Es: Completare il report">
                <div class="slot-options">
                    <div class="star-selector" data-stars="3">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
            <div class="daily-slot" data-slot="bonus">
                <div class="slot-header">‚ö° Azione Bonus</div>
                <input type="text" class="slot-name" placeholder="Es: Chiamare il medico">
                <div class="slot-options">
                    <div class="star-selector" data-stars="2">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star dim" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
            <div class="daily-slot" data-slot="movement">
                <div class="slot-header">üö∂ Movimento</div>
                <input type="text" class="slot-name" placeholder="Es: Passeggiata 30min">
                <div class="slot-options">
                    <div class="star-selector" data-stars="2">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star" data-value="2">‚≠ê</span>
                        <span class="star dim" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
            <div class="daily-slot" data-slot="reaction">
                <div class="slot-header">üõ°Ô∏è Reazione</div>
                <input type="text" class="slot-name" placeholder="Es: Rispondere a 3 email">
                <div class="slot-options">
                    <div class="star-selector" data-stars="1">
                        <span class="star" data-value="1">‚≠ê</span>
                        <span class="star dim" data-value="2">‚≠ê</span>
                        <span class="star dim" data-value="3">‚≠ê</span>
                        <span class="star dim" data-value="4">‚≠ê</span>
                        <span class="star dim" data-value="5">‚≠ê</span>
                    </div>
                    <select class="slot-stat"></select>
                </div>
            </div>
        </div>
        <div id="diceRollResult" class="dice-result hidden">
            <div class="dice-container">
                <div class="d10-dice" id="d10Dice">?</div>
            </div>
            <div class="dice-bonus" id="diceBonus"></div>
        </div>
        <div class="daily-planner-actions" style="display: flex; gap: 8px; margin-top: 10px;">
            <button class="recap-close-btn"
                style="flex:1; background: var(--bg-primary); color: var(--text-primary); padding: 10px;"
                onclick="closeDailyPlanner()">Salta</button>
            <button class="recap-close-btn" style="flex:2;" id="rollDiceBtn" onclick="rollD10AndSave()">üé≤ Lancia un
                D10!</button>
        </div>
    </div>

    <!-- Weekly Recap Modal -->
    <div class="recap-overlay hidden" id="weeklyRecapOverlay" onclick="closeWeeklyRecap()"></div>
    <div class="recap-popup hidden" id="weeklyRecapModal">
        <div class="recap-header">
            <h2>üìä Recap Settimanale</h2>
            <span class="recap-week" id="recapWeekLabel"></span>
        </div>
        <div class="recap-cards" id="recapCards">
            <!-- Dynamically populated -->
        </div>
        <button class="recap-close-btn" onclick="closeWeeklyRecap()">Continua üöÄ</button>
    </div>

    <!-- Motto Edit Modal -->
    <div class="modal-overlay" id="mottoEditModal">
        <div class="modal motto-modal">
            <div class="modal-header">
                <h3>Modifica Motto</h3>
                <button class="modal-close" onclick="closeMottoEdit()">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="mottoEditInput" class="motto-textarea" placeholder="Scrivi il tuo motto..." rows="3"
                    maxlength="100"></textarea>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeMottoEdit()">Annulla</button>
                    <button class="btn-primary" onclick="confirmMottoEdit()">Salva</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Archive Modal -->
    <div class="modal-overlay" id="archiveModal">
        <div class="modal archive-modal">
            <div class="modal-header">
                <h3>üìú Storico Imprese</h3>
                <button class="modal-close" onclick="closeArchive()">&times;</button>
            </div>
            <div class="modal-body archive-body">
                <div class="archive-list" id="archiveList">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Immersive Background Canvas -->
    <canvas id="bgCanvas"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; pointer-events: none; opacity: 0; transition: opacity 2s;"></canvas>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js?v=2.7.30')
                .then(() => console.log('Service Worker Registered'))
                .catch((err) => console.log('SW Failed:', err));
        }
    </script>
    <!-- PWA Install Instructions Modal -->
    <div class="modal-overlay hidden" id="installOverlay" onclick="closeInstallModal()"></div>
    <div class="profile-popup popup-center hidden" id="installModal" style="max-width:350px;">
        <div class="popup-header-info" style="margin-bottom: 10px; justify-content: center;">
            <div class="popup-avatar-frame" style="width: 50px; height: 50px;">
                <div class="popup-emoji" style="font-size: 24px;">üì≤</div>
            </div>
        </div>
        <h3 style="text-align: center; margin-bottom: 15px;">Installa App</h3>

        <div class="popup-details">
            <p
                style="text-align: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 14px; line-height: 1.4;">
                Salva l'app sulla Home per averla sempre con te a schermo intero!
            </p>

            <div
                style="background: var(--bg-primary); padding: 15px; border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                <ol style="padding-left: 20px; font-size: 13px; color: var(--text-primary); line-height: 1.6;">
                    <li style="margin-bottom: 8px;">
                        Apri il menu del browser (<span style="font-style: normal;">üì§</span> su iOS, <span
                            style="font-style: normal;">‚ãÆ</span> su Android).
                    </li>
                    <li style="margin-bottom: 8px;">
                        Seleziona <strong>"Aggiungi alla schermata Home"</strong> o <strong>"Installa app"</strong>.
                    </li>
                    <li>
                        Conferma cliccando su <strong>Aggiungi</strong>.
                    </li>
                </ol>
            </div>

            <div
                style="margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 12px; color: var(--text-muted);">
                <input type="checkbox" id="dontShowInstallAgain" onchange="toggleDontShowInstall(this.checked)"
                    style="accent-color: var(--accent-primary);">
                <label for="dontShowInstallAgain">Non mostrare pi√π in automatico</label>
            </div>

            <button class="settings-btn" onclick="closeInstallModal()"
                style="margin-top: 15px; width: 100%; justify-content: center; background: var(--accent-gradient); color: white; border: none;">
                Capito!
            </button>
        </div>
    </div>

</body>

</html>